import React from 'react';
import { Link } from 'react-router-dom';
import { BookOpen, CheckCircle, Award, TrendingUp, Clock, ArrowRight, Calendar, Megaphone } from 'lucide-react';
import { useAuth } from '../../context/AuthContext';
import { useData } from '../../context/DataContext';

const EmployeeDashboard = () => {
  const { user } = useAuth();
  const { data } = useData();

  const myEnrollments = (data.enrollments || []).filter(e => e.employeeId === user?.id);
  const inProgress = myEnrollments.filter(e => e.status === 'in_progress');
  const completed = myEnrollments.filter(e => e.status === 'completed');
  const myCerts = (data.employeeCertificates || []).filter(c => c.employeeId === user?.id);
  const myQuizzes = (data.quizAttempts || []).filter(q => q.employeeId === user?.id);
  const avgScore = myQuizzes.length > 0
    ? Math.round(myQuizzes.reduce((sum, q) => sum + q.score, 0) / myQuizzes.length)
    : 0;
  const myLearningPaths = (data.learningPathEnrollments || []).filter(lp => lp.employeeId === user?.id);

  const getModule = (moduleId: string) => data.modules.find(m => m.id === moduleId);

  const stats = [
    { label: 'In Progress', value: inProgress.length, icon: BookOpen, color: 'text-blue-500', bg: 'bg-blue-50' },
    { label: 'Completed', value: completed.length, icon: CheckCircle, color: 'text-emerald-500', bg: 'bg-emerald-50' },
    { label: 'Certificates', value: myCerts.length, icon: Award, color: 'text-amber-500', bg: 'bg-amber-50' },
    { label: 'Avg Quiz Score', value: `${avgScore}%`, icon: TrendingUp, color: 'text-violet-500', bg: 'bg-violet-50' },
  ];

  return (
    <div className="space-y-6 fade-in">
      {/* Welcome */}
      <div>
        <h1 className="text-2xl font-bold text-main-heading">Welcome back, {user?.name?.split(' ')[0]}!</h1>
        <p className="text-sm text-slate-500 mt-1">Here's your learning overview for today.</p>
      </div>

      {/* Stat Cards */}
      <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
        {stats.map(stat => (
          <div key={stat.label} className="bg-main-surface p-4 rounded-2xl border border-main-border shadow-sm transition-colors">
            <div className="flex items-center gap-3 mb-3">
              <div className={`p-2 rounded-xl ${stat.bg}`}>
                <stat.icon size={20} className={stat.color} />
              </div>
            </div>
            <p className="text-2xl font-bold text-main-heading">{stat.value}</p>
            <p className="text-xs text-slate-500 font-medium mt-0.5">{stat.label}</p>
          </div>
        ))}
      </div>

      <div className="grid grid-cols-1 xl:grid-cols-3 gap-4">
        {/* Continue Learning */}
        <div className="xl:col-span-2 space-y-4">
          <div className="bg-main-surface p-5 rounded-2xl border border-main-border shadow-sm transition-colors">
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-base font-bold text-main-heading">Continue Learning</h2>
              <Link to="/employee/courses" className="text-main-heading bg-main-bg px-3 py-1.5 rounded-full font-bold text-[10px] hover:bg-main-border transition-colors">
                View All
              </Link>
            </div>

            {inProgress.length === 0 ? (
              <div className="text-center py-8">
                <BookOpen size={40} className="mx-auto text-slate-300 mb-3" />
                <p className="text-sm text-slate-500">No courses in progress.</p>
                <Link to="/employee/courses" className="text-sm text-brand-primary font-semibold mt-2 inline-block hover:underline">
                  Browse Catalog
                </Link>
              </div>
            ) : (
              <div className="space-y-3">
                {inProgress.map(enrollment => {
                  const mod = getModule(enrollment.moduleId);
                  if (!mod) return null;
                  return (
                    <Link
                      key={enrollment.id}
                      to={`/employee/courses/${mod.id}`}
                      className="flex items-center gap-4 p-3 rounded-xl border border-main-border hover:border-brand-primary/30 hover:shadow-sm transition-all group"
                    >
                      <img src={mod.thumbnail} alt={mod.title} className="w-14 h-14 rounded-xl object-cover" />
                      <div className="flex-1 min-w-0">
                        <p className="text-sm font-bold text-main-heading truncate group-hover:text-brand-primary transition-colors">{mod.title}</p>
                        <p className="text-xs text-slate-500 mt-0.5">{mod.instructor}</p>
                        <div className="flex items-center gap-2 mt-2">
                          <div className="flex-1 h-1.5 bg-main-bg rounded-full overflow-hidden">
                            <div className="h-full bg-brand-primary rounded-full transition-all" style={{ width: `${enrollment.progress}%` }} />
                          </div>
                          <span className="text-[10px] font-bold text-slate-500">{enrollment.progress}%</span>
                        </div>
                      </div>
                      <ArrowRight size={18} className="text-slate-300 group-hover:text-brand-primary transition-colors shrink-0" />
                    </Link>
                  );
                })}
              </div>
            )}
          </div>

          {/* Learning Path Progress */}
          {myLearningPaths.length > 0 && (
            <div className="bg-main-surface p-5 rounded-2xl border border-main-border shadow-sm transition-colors">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-base font-bold text-main-heading">Learning Path Progress</h2>
                <Link to="/employee/learning-paths" className="text-main-heading bg-main-bg px-3 py-1.5 rounded-full font-bold text-[10px] hover:bg-main-border transition-colors">
                  View All
                </Link>
              </div>
              <div className="space-y-3">
                {myLearningPaths.map(lpe => {
                  const path = data.learningPaths.find(lp => lp.id === lpe.learningPathId);
                  if (!path) return null;
                  return (
                    <div key={lpe.id} className="p-3 rounded-xl border border-main-border">
                      <div className="flex justify-between items-center mb-2">
                        <p className="text-sm font-bold text-main-heading">{path.title}</p>
                        <span className="text-[10px] font-bold text-slate-500">{lpe.progress}%</span>
                      </div>
                      <div className="h-2 bg-main-bg rounded-full overflow-hidden">
                        <div className="h-full bg-emerald-500 rounded-full transition-all" style={{ width: `${lpe.progress}%` }} />
                      </div>
                      <p className="text-xs text-slate-500 mt-1.5">{path.moduleCount} modules Â· {path.duration}</p>
                    </div>
                  );
                })}
              </div>
            </div>
          )}
        </div>

        {/* Right column */}
        <div className="space-y-4">
          {/* Upcoming Events */}
          <div className="bg-main-surface p-5 rounded-2xl border border-main-border shadow-sm transition-colors">
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-base font-bold text-main-heading">Upcoming Events</h2>
              <Link to="/employee/calendar" className="text-main-heading bg-main-bg px-3 py-1.5 rounded-full font-bold text-[10px] hover:bg-main-border transition-colors">
                View All
              </Link>
            </div>
            <div className="space-y-3">
              {data.calendarEvents.slice(0, 3).map(event => (
                <div key={event.id} className="flex items-center gap-3 p-2.5 rounded-lg border border-main-border">
                  <div className="flex flex-col items-center justify-center bg-brand-primary/10 rounded-lg px-2.5 py-1.5 min-w-[44px]">
                    <span className="text-xs font-bold text-brand-primary">{event.month}</span>
                    <span className="text-lg font-bold text-brand-primary leading-none">{event.day}</span>
                  </div>
                  <div className="flex-1 min-w-0">
                    <p className="text-sm font-bold text-main-heading truncate">{event.title}</p>
                    <div className="flex items-center gap-1.5 mt-0.5">
                      <Clock size={11} className="text-slate-400" />
                      <span className="text-[11px] text-slate-500">{event.time}</span>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>

          {/* Recent Announcements */}
          <div className="bg-main-surface p-5 rounded-2xl border border-main-border shadow-sm transition-colors">
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-base font-bold text-main-heading">Announcements</h2>
              <Link to="/employee/announcements" className="text-main-heading bg-main-bg px-3 py-1.5 rounded-full font-bold text-[10px] hover:bg-main-border transition-colors">
                View All
              </Link>
            </div>
            <div className="space-y-3">
              {data.announcements.slice(0, 3).map(ann => (
                <div key={ann.id} className="p-2.5 rounded-lg border border-main-border">
                  <div className="flex items-center gap-2 mb-1">
                    <Megaphone size={12} className="text-brand-primary shrink-0" />
                    <p className="text-sm font-bold text-main-heading truncate">{ann.title}</p>
                  </div>
                  <p className="text-xs text-slate-500 line-clamp-2">{ann.content}</p>
                  <p className="text-[10px] text-slate-400 mt-1">{ann.date}</p>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default EmployeeDashboard;
